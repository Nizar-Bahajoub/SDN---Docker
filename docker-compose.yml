services:

  pox:
    build: ./pox
    container_name: pox-controller
    hostname: pox
    networks:
      management:
        ipv4_address: 172.20.100.10
      data:
        ipv4_address: 172.20.200.10
    ports:
      - "6633:6633"
    environment:
      - DETECTOR_URL=http://172.20.100.20:8000/predict
      - DETECTOR_TIMEOUT=2.0
      - DETECTOR_SECRET=supersecret123
      - LOCAL_MODEL_PATH=/pox/models/model.pkl
      - LOCAL_MODEL_THRESHOLD=0.5
      - ROUTER_MAC=00:00:00:00:00:01
      - PORT_LOCKING=true
      - MAC_MOVE_BLOCK=true
    volumes:
      - ./pox/controllers:/pox/pox/ext:ro
      - ./pox/models:/pox/models:ro
    command: ["python3","pox.py","log.level","--DEBUG","openflow.of_01","--port=6633","--address=0.0.0.0","ext.defense_with_ml"]

  mininet:
    build: ./mininet
    container_name: mininet-sim
    hostname: mininet
    privileged: true
    cap_add:
      - ALL
    networks:
      data:
        ipv4_address: 172.20.200.20
    volumes:
      - ./mininet/topologies:/topologies
    depends_on:
      - pox
    command: tail -f /dev/null
    stdin_open: true
    tty: true

  detector:
    build: ./detector
    container_name: detector
    hostname: detector
    networks:
      management:
        ipv4_address: 172.20.100.20
    ports:
      - "8000:8000"
    environment:
      - MODEL_PATH=/models/model.pkl
      - DETECTOR_SECRET=supersecret123
    volumes:
      - ./detector/models:/models
    command: ["python3","/detector/detector_service.py"]

networks:
  management:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.100.0/24
  data:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.200.0/24
